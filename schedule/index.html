<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My School Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://img.freepik.com/free-vector/black-yellow-grunge-background_1409-1587.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: white;
        }
        .hidden {
            display: none;
        }
        /* Style for the PIN input */
        #pin-input {
            letter-spacing: 0.5em;
            text-align: center;
        }
        .timer-segment {
            transition: transform 0.2s ease-in-out;
        }
        .timer-segment:hover {
            transform: scale(1.05);
        }
        /* Calendar Styles */
        .calendar-day {
            transition: background-color 0.2s;
            position: relative;
        }
        .calendar-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #f59e0b; /* amber-500 */
        }
        .calendar-day.selected {
            background-color: #f59e0b;
            color: #18181b; /* zinc-900 */
        }
        .schedule-day-indicator {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 0.65rem;
            font-weight: bold;
            color: #facc15; /* yellow-400 */
            opacity: 0.8;
        }
        /* Style date picker to match theme */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        /* Hallway View Styles */
        .text-shadow {
            text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div id="app-container" class="bg-zinc-900/80 backdrop-blur-sm p-8 md:p-10 rounded-2xl shadow-2xl w-full max-w-2xl text-center">
        <!-- ===================================================================== -->
        <!-- MAIN COUNTDOWN VIEW -->
        <!-- ===================================================================== -->
        <div id="main-view">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTgGPFjIfm0pERL_lXQYygRFXJm5Be01Kp9ho1JnEo-CJOxPfUAjRZf_e1w3WFrfBTH-Q&usqp=CAU" alt="School Logo" class="h-16 mx-auto mb-4">
            <p id="current-time" class="text-sm text-zinc-400 mb-2"></p>
            <h1 class="text-3xl md:text-4xl font-bold mb-2 text-yellow-400">Live Schedule</h1>
            
            <div class="mb-6">
                <label for="day-selector" class="block text-sm font-medium text-zinc-400 mb-2">Select a Day:</label>
                <select id="day-selector" class="bg-zinc-800 text-white text-lg p-3 rounded-lg border-2 border-zinc-700 focus:border-yellow-500 focus:outline-none w-full">
                    <option value="1">Day 1</option>
                    <option value="2">Day 2</option>
                    <option value="3">Day 3</option>
                    <option value="4">Day 4</option>
                    <option value="5">Day 5</option>
                    <option value="6">Day 6</option>
                    <option value="7">Day 7</option>
                    <option value="iss">ISS</option>
                    <option value="stingfest">Sting Fest</option> <!-- Added Sting Fest option -->
                </select>
            </div>

            <div id="countdown-container" class="bg-black p-6 rounded-lg min-h-[240px] flex flex-col justify-center">
                <!-- Live Countdown Display -->
                <div id="live-timer-view">
                    <p id="class-info-text" class="text-xl font-semibold text-yellow-300 min-h-[1.75rem]"></p>
                    <p id="teacher-info-text" class="text-lg text-zinc-300 mb-2 min-h-[1.5rem]"></p>
                    <p id="period-times-text" class="text-sm text-zinc-400 mb-1 min-h-[1.25rem]"></p>
                    <p id="status-text" class="text-zinc-400 mb-4 min-h-[1.25rem]"></p>

                    <div id="timer-display" class="flex justify-center items-end space-x-4 md:space-x-6 text-5xl md:text-7xl font-bold">
                        <div class="timer-segment flex flex-col items-center"><span id="hours">00</span><span class="text-base font-medium text-zinc-500 mt-1">Hours</span></div>
                        <span class="text-5xl md:text-6xl pb-6">:</span>
                        <div class="timer-segment flex flex-col items-center"><span id="minutes">00</span><span class="text-base font-medium text-zinc-500 mt-1">Minutes</span></div>
                        <span class="text-5xl md:text-6xl pb-6">:</span>
                        <div class="timer-segment flex flex-col items-center"><span id="seconds">00</span><span class="text-base font-medium text-zinc-500 mt-1">Seconds</span></div>
                    </div>
                     <p id="next-class-text" class="text-zinc-400 mt-4 min-h-[1.25rem] text-sm"></p>
                </div>
                 <!-- Finished Message -->
                <div id="finished-message" class="hidden">
                    <h2 class="text-3xl font-bold text-yellow-400">School's Out!</h2>
                    <p class="text-zinc-400 mt-2">Enjoy your day!</p>
                </div>
            </div>

            <div id="auth-container-signed-out" class="mt-8 flex flex-col sm:flex-row gap-4">
                <a href="https://forms.gle/8csJnJJrsbtLmGNL8" target="_blank" class="w-full bg-zinc-800 hover:bg-zinc-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300 flex items-center justify-center">Sign Up</a>
                <button id="sign-in-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300">Sign In</button>
            </div>
            <div id="auth-container-signed-in" class="hidden">
                <div class="grid grid-cols-2 gap-4 mt-8">
                    <button id="edit-schedule-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300">Edit Schedule</button>
                    <button id="calendar-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300">Calendar</button>
                    <button id="sign-out-btn" class="col-span-2 w-full bg-zinc-800 hover:bg-zinc-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300">Sign Out</button>
                </div>
            </div>
             <div class="mt-4">
                <button id="hallway-view-btn" class="w-full bg-zinc-700 hover:bg-zinc-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300">Hallway Display</button>
            </div>
        </div>

        <!-- ===================================================================== -->
        <!-- PIN VIEW -->
        <!-- ===================================================================== -->
        <div id="pin-view" class="hidden">
            <h2 class="text-3xl font-bold mb-4 text-yellow-400">Enter PIN</h2>
            <p class="text-zinc-400 mb-4">Enter your 4-digit PIN to edit the schedule.</p>
            <input type="password" id="pin-input" maxlength="4" class="bg-zinc-800 text-white text-3xl p-3 rounded-lg border-2 border-zinc-700 focus:border-yellow-500 focus:outline-none w-full" />
            <p id="pin-error" class="text-red-400 h-5 mt-2"></p>
            <div class="flex gap-4 mt-4">
                 <button id="pin-submit-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300">Enter</button>
                 <button id="pin-back-btn" class="w-full bg-zinc-800 hover:bg-zinc-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300">Back</button>
            </div>
        </div>

        <!-- ===================================================================== -->
        <!-- SCHEDULE EDITOR VIEW -->
        <!-- ===================================================================== -->
        <div id="schedule-view" class="hidden">
            <h2 class="text-3xl font-bold mb-4 text-yellow-400">Edit Master Schedule (Day 1)</h2>
            <p class="text-zinc-400 mb-4">Changes here will affect all other days.</p>
            
            <div id="periods-container" class="space-y-4 max-h-80 overflow-y-auto pr-2">
                <!-- Period entries will be dynamically inserted here -->
            </div>
            
            <button id="add-period-btn" class="mt-4 w-full bg-zinc-800 hover:bg-zinc-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">+ Add Period</button>
            
            <div class="flex gap-4 mt-6">
                 <button id="save-schedule-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300">Save & Close</button>
                 <button id="back-to-main-btn" class="w-full bg-zinc-800 hover:bg-zinc-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300">Cancel</button>
            </div>
        </div>

        <!-- ===================================================================== -->
        <!-- CALENDAR VIEW -->
        <!-- ===================================================================== -->
        <div id="calendar-view" class="hidden">
            <h2 class="text-3xl font-bold mb-4 text-yellow-400">School Calendar</h2>
            <div class="bg-black p-4 rounded-lg">
                <div id="calendar-header" class="flex items-center justify-between mb-4">
                    <button id="prev-month-btn" class="text-yellow-400 hover:text-yellow-300 text-2xl font-bold">&lt;</button>
                    <div class="flex items-center gap-4">
                        <h3 id="month-year" class="text-xl font-semibold"></h3>
                        <button id="today-btn" class="text-sm bg-zinc-700 hover:bg-zinc-600 px-3 py-1 rounded-md transition-colors">Today</button>
                    </div>
                    <button id="next-month-btn" class="text-yellow-400 hover:text-yellow-300 text-2xl font-bold">&gt;</button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center">
                    <div class="text-zinc-500 font-bold">S</div>
                    <div class="text-zinc-500 font-bold">M</div>
                    <div class="text-zinc-500 font-bold">T</div>
                    <div class="text-zinc-500 font-bold">W</div>
                    <div class="text-zinc-500 font-bold">T</div>
                    <div class="text-zinc-500 font-bold">F</div>
                    <div class="text-zinc-500 font-bold">S</div>
                </div>
                <div id="calendar-days" class="grid grid-cols-7 gap-1 mt-2">
                    <!-- Days will be dynamically inserted here -->
                </div>
            </div>
            <div id="event-view" class="mt-4 text-left">
                <h4 id="selected-date-text" class="font-bold text-lg text-yellow-400">Select a date</h4>
                <div id="event-list" class="mt-2 space-y-2 max-h-24 overflow-y-auto"></div>
                <div class="flex gap-2 mt-4">
                    <input type="text" id="event-input" placeholder="Add an event..." class="bg-zinc-800 text-white p-2 rounded-md w-full border border-zinc-700 focus:border-yellow-500 focus:outline-none">
                    <button id="add-event-btn" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded-md transition-all duration-300">Add</button>
                </div>
                <div class="flex items-center gap-2 mt-4 border-t border-zinc-800 pt-4">
                    <label for="day-type-selector" class="text-sm text-zinc-400 whitespace-nowrap">Schedule Day:</label>
                    <select id="day-type-selector" class="bg-zinc-800 text-white p-2 rounded-md w-full border border-zinc-700 focus:border-yellow-500 focus:outline-none">
                        <option value="0">None</option>
                        <option value="1">Day 1</option>
                        <option value="2">Day 2</option>
                        <option value="3">Day 3</option>
                        <option value="4">Day 4</option>
                        <option value="5">Day 5</option>
                        <option value="6">Day 6</option>
                        <option value="7">Day 7</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 mt-4 border-t border-zinc-800 pt-4">
                    <label for="date-picker-input" class="text-sm text-zinc-400 whitespace-nowrap">Go to date:</label>
                    <input type="date" id="date-picker-input" class="bg-zinc-800 text-white p-2 rounded-md w-full border border-zinc-700 focus:border-yellow-500 focus:outline-none">
                    <button id="go-to-date-btn" class="bg-zinc-700 hover:bg-zinc-600 text-white font-bold py-2 px-4 rounded-md transition-all duration-300">Go</button>
                </div>
            </div>
             <button id="calendar-back-btn" class="mt-6 w-full bg-zinc-800 hover:bg-zinc-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300">Back to Schedule</button>
        </div>
    </div>

    <!-- ===================================================================== -->
    <!-- HALLWAY VIEW -->
    <!-- ===================================================================== -->
    <div id="hallway-view" class="hidden flex-col items-center justify-center h-screen w-screen p-8 fixed top-0 left-0 bg-black/30">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTgGPFjIfm0pERL_lXQYygRFXJm5Be01Kp9ho1JnEo-CJOxPfUAjRZf_e1w3WFrfBTH-Q&usqp=CAU" alt="School Logo" class="absolute top-5 left-5 h-12">
        <button id="hallway-back-btn" class="absolute top-5 right-5 bg-zinc-800/50 hover:bg-zinc-700/50 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">Back</button>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-7xl mx-auto">
            <!-- Left Column -->
            <div class="md:col-span-1 flex flex-col justify-center items-center text-center">
                <h2 id="hallway-day-title" class="text-9xl font-black text-shadow">Day</h2>
                <p id="hallway-day-number" class="text-9xl font-black text-shadow -mt-4">--</p>
            </div>

            <!-- Right Column -->
            <div class="md:col-span-2 flex flex-col">
                <div class="flex justify-between items-baseline mb-4">
                    <h1 class="text-5xl font-bold text-yellow-400 text-shadow">Live Schedule</h1>
                    <div class="text-right">
                        <p id="current-time-large" class="text-3xl font-bold text-shadow">12:00:00 PM</p>
                        <p id="current-date-large" class="text-lg text-zinc-300 text-shadow">Wednesday, October 15, 2025</p>
                    </div>
                </div>

                <div id="schedule-info" class="bg-black/60 p-8 rounded-2xl w-full flex-grow flex flex-col justify-center">
                    <p id="hallway-class-name" class="text-4xl font-bold text-yellow-300 min-h-[3rem]"></p>
                    <p id="hallway-teacher-name" class="text-2xl text-zinc-300 min-h-[2rem]"></p>
                    <p id="hallway-period-times" class="text-lg text-zinc-400 mb-2 min-h-[1.5rem]"></p>
                    <p id="hallway-status-text" class="text-zinc-400 mb-4 min-h-[1.25rem]"></p>

                    <div id="timer-display-large" class="flex justify-center items-end space-x-4 md:space-x-6 text-7xl md:text-8xl font-bold">
                        <div class="timer-segment flex flex-col items-center"><span id="hallway-hours">00</span><span class="text-base font-medium text-zinc-500 mt-1">Hours</span></div>
                        <span class="text-7xl md:text-8xl pb-6">:</span>
                        <div class="timer-segment flex flex-col items-center"><span id="hallway-minutes">00</span><span class="text-base font-medium text-zinc-500 mt-1">Minutes</span></div>
                        <span class="text-7xl md:text-8xl pb-6">:</span>
                        <div class="timer-segment flex flex-col items-center"><span id="hallway-seconds">00</span><span class="text-base font-medium text-zinc-500 mt-1">Seconds</span></div>
                    </div>
                     <p id="hallway-next-class" class="text-zinc-400 mt-4 min-h-[1.25rem] text-lg"></p>
                </div>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM ELEMENTS (MAIN APP) ---
        const appContainer = document.getElementById('app-container');
        const mainView = document.getElementById('main-view');
        const scheduleView = document.getElementById('schedule-view');
        const pinView = document.getElementById('pin-view');
        const calendarView = document.getElementById('calendar-view');

        const signInBtn = document.getElementById('sign-in-btn');
        const pinInput = document.getElementById('pin-input');
        const pinSubmitBtn = document.getElementById('pin-submit-btn');
        const pinBackBtn = document.getElementById('pin-back-btn');
        const pinError = document.getElementById('pin-error');

        const authContainerSignedOut = document.getElementById('auth-container-signed-out');
        const authContainerSignedIn = document.getElementById('auth-container-signed-in');
        const editScheduleBtn = document.getElementById('edit-schedule-btn');
        const calendarBtn = document.getElementById('calendar-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const hallwayViewBtn = document.getElementById('hallway-view-btn');
        
        const saveScheduleBtn = document.getElementById('save-schedule-btn');
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const addPeriodBtn = document.getElementById('add-period-btn');
        const daySelector = document.getElementById('day-selector');
        const periodsContainer = document.getElementById('periods-container');
        
        const liveTimerView = document.getElementById('live-timer-view');
        const finishedMessage = document.getElementById('finished-message');
        const classInfoText = document.getElementById('class-info-text');
        const teacherInfoText = document.getElementById('teacher-info-text');
        const periodTimesText = document.getElementById('period-times-text');
        const statusText = document.getElementById('status-text');
        const nextClassText = document.getElementById('next-class-text');
        const hoursEl = document.getElementById('hours');
        const minutesEl = document.getElementById('minutes');
        const secondsEl = document.getElementById('seconds');
        const currentTimeEl = document.getElementById('current-time');
        
        // --- DOM ELEMENTS (CALENDAR) ---
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const monthYearText = document.getElementById('month-year');
        const todayBtn = document.getElementById('today-btn');
        const calendarDays = document.getElementById('calendar-days');
        const selectedDateText = document.getElementById('selected-date-text');
        const eventList = document.getElementById('event-list');
        const eventInput = document.getElementById('event-input');
        const addEventBtn = document.getElementById('add-event-btn');
        const dayTypeSelector = document.getElementById('day-type-selector');
        const calendarBackBtn = document.getElementById('calendar-back-btn');
        const datePickerInput = document.getElementById('date-picker-input');
        const goToDateBtn = document.getElementById('go-to-date-btn');

        // --- DOM ELEMENTS (HALLWAY VIEW) ---
        const hallwayView = document.getElementById('hallway-view');
        const hallwayBackBtn = document.getElementById('hallway-back-btn');
        const timeElLarge = document.getElementById('current-time-large');
        const dateElLarge = document.getElementById('current-date-large');
        const hallwayDayTitleEl = document.getElementById('hallway-day-title');
        const hallwayDayNumberEl = document.getElementById('hallway-day-number');
        const hallwayClassNameEl = document.getElementById('hallway-class-name');
        const hallwayTeacherNameEl = document.getElementById('hallway-teacher-name');
        const hallwayPeriodTimesEl = document.getElementById('hallway-period-times');
        const hallwayStatusTextEl = document.getElementById('hallway-status-text');
        const hallwayNextClassEl = document.getElementById('hallway-next-class');
        const hallwayHoursEl = document.getElementById('hallway-hours');
        const hallwayMinutesEl = document.getElementById('hallway-minutes');
        const hallwaySecondsEl = document.getElementById('hallway-seconds');


        // --- STATE ---
        let schedule = {};
        let events = {};
        let mainInterval;
        let hallwayInterval;
        let isSignedIn = false;
        let calendarDate = new Date();
        let selectedDate = null;
        
        const defaultSchedule = {
            "1": [
                { class: "M/J Language Arts 3", teacher: "Rebecca Skinner", start: "08:35", end: "09:23", lunch: "A" },
                { class: "M/J World History", teacher: "Sandra Badger", start: "09:27", end: "10:14", lunch: "B" },
                { class: "M/J Comp Science 3", teacher: "Nancy Schilling", start: "10:18", end: "11:05", lunch: "A" },
                { class: "M/J Guitar 1", teacher: "Mackenzie Torres", start: "11:39", end: "12:39", lunch: "A" },
                { class: "M/J Critical Thinking", teacher: "Rebecca Skinner", start: "12:53", end: "13:29", lunch: "B" },
                { class: "Intro to Education", teacher: "Debbie Torres", start: "13:33", end: "14:18", lunch: "A" },
                { class: "Pre-AP Algebra 1", teacher: "Jeffery Shumate", start: "14:20", end: "15:10", lunch: "B" }
            ],
        };

        const stingFestSchedule = [
            { class: "Period 4", start: "08:35", end: "08:45" },
            { class: "Rotation 1", start: "08:50", end: "09:30" },
            { class: "Rotation 2", start: "09:35", end: "10:30" },
            { class: "Lunch", start: "10:30", end: "11:00" },
            { class: "Rotation 3", start: "11:05", end: "11:45" },
            { class: "Period 4", start: "11:50", end: "12:10" }
        ];

        const issBreakTimes = ["10:15", "12:10", "13:20", "14:18"];

        const defaultEvents = {
            "2025-10-15": { events: [], scheduleDay: 5 },
            "2025-10-16": { events: [], scheduleDay: 4 },
            "2025-10-17": { events: [], scheduleDay: 3 },
            "2025-10-20": { events: [], scheduleDay: 2 },
            "2025-10-21": { events: [], scheduleDay: 1 },
            "2025-10-22": { events: ["Picture Retakes/Makeups"], scheduleDay: 7 },
            "2025-10-23": { events: [], scheduleDay: 6 },
            "2025-10-24": { events: ["Sting Fest / Half Day"], scheduleDay: 5 }, // Marked as Day 5 for now
            "2025-10-27": { events: [], scheduleDay: 4 },
            "2025-10-28": { events: [], scheduleDay: 3 },
            "2025-10-29": { events: [], scheduleDay: 2 },
            "2025-10-30": { events: [], scheduleDay: 1 },
            "2025-10-31": { events: ["District In Service Day, Students not in attendance."], scheduleDay: 0 },
            "2025-11-03": { events: [], scheduleDay: 7 },
            "2025-11-04": { events: [], scheduleDay: 6 },
            "2025-11-05": { events: [], scheduleDay: 5 },
            "2025-11-06": { events: [], scheduleDay: 4 },
            "2025-11-07": { events: [], scheduleDay: 3 },
            "2025-11-10": { events: [], scheduleDay: 2 },
            "2025-11-11": { events: ["Veterans Day / No School"], scheduleDay: 0 },
            "2025-11-12": { events: [], scheduleDay: 7 },
            "2025-11-13": { events: [], scheduleDay: 6 },
            "2025-11-14": { events: [], scheduleDay: 5 },
            "2025-11-24": { events: ["Thanksgiving Break"], scheduleDay: 0 },
            "2025-11-25": { events: ["Thanksgiving Break"], scheduleDay: 0 },
            "2025-11-26": { events: ["Thanksgiving Break"], scheduleDay: 0 },
            "2025-11-27": { events: ["Thanksgiving Break"], scheduleDay: 0 },
            "2025-11-28": { events: ["Thanksgiving Break"], scheduleDay: 0 },
            "2025-12-17": { events: ["End of Semester-Early Release at 12:10 pm"], scheduleDay: 0 },
            "2025-12-18": { events: ["End of Semester-Early Release at 12:10 pm"], scheduleDay: 0 },
            "2025-12-19": { events: ["End of Semester-Early Release at 12:10 pm"], scheduleDay: 0 },
            "2025-12-22": { events: ["Winter Break"], scheduleDay: 0 },
            "2025-12-23": { events: ["Winter Break"], scheduleDay: 0 },
            "2025-12-24": { events: ["Winter Break"], scheduleDay: 0 },
            "2025-12-25": { events: ["Winter Break"], scheduleDay: 0 },
            "2025-12-26": { events: ["Winter Break"], scheduleDay: 0 },
            "2025-12-27": { events: ["Winter Break"], scheduleDay: 0 },
            "2025-12-28": { events: ["Winter Break"], scheduleDay: 0 },
            "2025-12-29": { events: ["Winter Break"], scheduleDay: 0 },
            "2025-12-30": { events: ["Winter Break"], scheduleDay: 0 },
            "2025-12-31": { events: ["Winter Break"], scheduleDay: 0 },
            "2026-01-01": { events: ["Winter Break"], scheduleDay: 0 },
            "2026-01-02": { events: ["Winter Break"], scheduleDay: 0 },
        };

        // --- GENERAL FUNCTIONS ---
        function updateCurrentTime() {
            const now = new Date();
            currentTimeEl.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
        }

        function showView(viewId) {
             if (viewId === 'hallway') {
                appContainer.classList.add('hidden');
                hallwayView.classList.remove('hidden');
                hallwayView.classList.add('flex');
                startHallwayDisplay();
            } else {
                hallwayView.classList.add('hidden');
                hallwayView.classList.remove('flex');
                appContainer.classList.remove('hidden');
                stopHallwayDisplay();

                mainView.classList.toggle('hidden', viewId !== 'main');
                scheduleView.classList.toggle('hidden', viewId !== 'scheduleEditor');
                pinView.classList.toggle('hidden', viewId !== 'pin');
                calendarView.classList.toggle('hidden', viewId !== 'calendar');
            }
        }

        function updateAuthUI() {
            authContainerSignedOut.classList.toggle('hidden', isSignedIn);
            authContainerSignedIn.classList.toggle('hidden', !isSignedIn);
        }

        function saveScheduleToStorage() { localStorage.setItem('classSchedule', JSON.stringify(schedule)); }
        function saveEventsToStorage() { localStorage.setItem('schoolEvents', JSON.stringify(events)); }
        function loadDataFromStorage() {
             const savedSchedule = localStorage.getItem('classSchedule');
            schedule = savedSchedule ? JSON.parse(savedSchedule) : JSON.parse(JSON.stringify(defaultSchedule));
            const savedEvents = localStorage.getItem('schoolEvents');
            events = savedEvents ? JSON.parse(savedEvents) : JSON.parse(JSON.stringify(defaultEvents));
        }

        function formatTime12Hour(timeStr) {
            if (!timeStr) return '';
            const [hour, minute] = timeStr.split(':');
            const hourNum = parseInt(hour, 10);
            const ampm = hourNum >= 12 ? 'PM' : 'AM';
            let hour12 = hourNum % 12;
            if (hour12 === 0) hour12 = 12;
            return `${hour12}:${minute} ${ampm}`;
        }
        
        const timeToDate = (timeStr) => {
            const [hour, minute] = timeStr.split(':');
            const date = new Date();
            date.setHours(hour, minute, 0, 0);
            return date;
        };

        // --- CORE LOGIC ---
        function getScheduleState(dayValue) {
            const now = new Date();
            let scheduleDay = ''; // Keep track of the resolved day (number or 'stingfest')
            let isStingFest = false;
            let resolvedDayValue = dayValue || daySelector.value; // Use passed value or dropdown value

            // Determine the schedule type (number, iss, stingfest)
            if (resolvedDayValue === 'iss') {
                 return { now, scheduleDay: 'ISS', currentPeriod: null, nextPeriod: null, daySchedule: [], isISS: true, isStingFest: false };
            } else if (resolvedDayValue === 'stingfest') {
                scheduleDay = 'Sting Fest';
                isStingFest = true;
            } else {
                 if (resolvedDayValue) { // If a specific day number is selected in dropdown
                    scheduleDay = resolvedDayValue;
                 } else { // Otherwise, determine from calendar/weekday (fallback if dropdown isn't set somehow)
                    const todayKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                    const todayEventData = events[todayKey] || { scheduleDay: 0 };
                    const dayOfWeek = now.getDay();
                    scheduleDay = todayEventData.scheduleDay > 0 ? String(todayEventData.scheduleDay) : (dayOfWeek === 0 || dayOfWeek === 6 ? '1' : String(dayOfWeek));
                 }
            }
            
            let daySchedule = [];
            if (isStingFest) {
                daySchedule = stingFestSchedule;
                scheduleDay = 'Fest'; // Short label for display
                hallwayDayTitleEl.textContent = 'Sting';
            } else {
                hallwayDayTitleEl.textContent = 'Day';
                const masterSchedule = schedule['1'] || [];
                if (masterSchedule.length === 0) return { now, scheduleDay, currentPeriod: null, nextPeriod: null, daySchedule: [], isISS: false, isStingFest: false };

                const dayIndex = parseInt(scheduleDay, 10);
                const startIndex = (dayIndex - 1) % masterSchedule.length;
                const rotatedClassInfo = masterSchedule.slice(startIndex).concat(masterSchedule.slice(0, startIndex));
                
                daySchedule = masterSchedule.map((originalPeriod, index) => {
                    return {
                        class: rotatedClassInfo[index].class,
                        teacher: rotatedClassInfo[index].teacher,
                        lunch: rotatedClassInfo[index].lunch,
                        start: originalPeriod.start,
                        end: originalPeriod.end
                    };
                });
            }


            let currentPeriod = null;
            let nextPeriod = null;
            for (let i = 0; i < daySchedule.length; i++) {
                const period = daySchedule[i];
                const startTime = timeToDate(period.start);
                const endTime = timeToDate(period.end);
                if (now >= startTime && now < endTime) { 
                    currentPeriod = period; 
                    if (i + 1 < daySchedule.length) { nextPeriod = daySchedule[i+1]; }
                    break; 
                }
                if (now < startTime && !nextPeriod) { nextPeriod = period; }
            }
            return { now, scheduleDay, currentPeriod, nextPeriod, daySchedule, isISS: false, isStingFest };
        }
        
        // --- DISPLAY UPDATE FUNCTIONS ---
        function updateMainDisplay() {
            const selectedDay = daySelector.value;
            
            if (selectedDay === 'iss') {
                const now = new Date();
                let nextBreakTarget = null;
                for (const breakTime of issBreakTimes) {
                    const breakDate = timeToDate(breakTime);
                    if (breakDate > now) {
                        nextBreakTarget = breakDate;
                        break;
                    }
                }
                
                liveTimerView.classList.remove('hidden');
                finishedMessage.classList.add('hidden');
                teacherInfoText.textContent = ''; periodTimesText.textContent = ''; nextClassText.textContent = '';
                
                if (nextBreakTarget) {
                    classInfoText.textContent = "In-School Suspension";
                    statusText.textContent = `Time until next break:`;
                    const distance = nextBreakTarget.getTime() - now.getTime();
                    const hours = Math.floor(distance / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    hoursEl.textContent = String(hours).padStart(2, '0');
                    minutesEl.textContent = String(minutes).padStart(2, '0');
                    secondsEl.textContent = String(seconds).padStart(2, '0');
                } else {
                    liveTimerView.classList.add('hidden');
                    finishedMessage.classList.remove('hidden');
                    finishedMessage.querySelector('h2').textContent = "ISS Day Complete";
                }
                return;
            }

            const { now, scheduleDay, currentPeriod, nextPeriod, daySchedule, isStingFest } = getScheduleState(selectedDay);
            
            liveTimerView.classList.remove('hidden');
            finishedMessage.classList.add('hidden');
            
            let targetTime;

            const lunchA_startTime = timeToDate('11:05'), lunchA_endTime = timeToDate('11:39');
            const lunchB_startTime = timeToDate('12:09'), lunchB_endTime = timeToDate('12:39');

            if (currentPeriod && !isStingFest && now >= lunchA_startTime && now < lunchA_endTime && currentPeriod.lunch === 'A') {
                classInfoText.textContent = "A Lunch"; 
                teacherInfoText.textContent = '';
                periodTimesText.textContent = `${formatTime12Hour('11:05')} - ${formatTime12Hour('11:39')}`;
                statusText.textContent = `Time left for lunch:`;
                targetTime = lunchA_endTime;
                nextClassText.textContent = '';
            } else if (currentPeriod && !isStingFest && now >= lunchB_startTime && now < lunchB_endTime && currentPeriod.lunch === 'B') {
                classInfoText.textContent = "B Lunch"; 
                teacherInfoText.textContent = '';
                periodTimesText.textContent = `${formatTime12Hour('12:09')} - ${formatTime12Hour('12:39')}`;
                statusText.textContent = `Time left for lunch:`;
                targetTime = lunchB_endTime;
                nextClassText.textContent = '';
            } else if (currentPeriod) { // Handles regular periods AND Sting Fest periods
                if (isSignedIn && !isStingFest) {
                    classInfoText.textContent = currentPeriod.class;
                    teacherInfoText.textContent = currentPeriod.teacher;
                } else if (isStingFest){
                     classInfoText.textContent = currentPeriod.class; // Show Sting Fest period name
                     teacherInfoText.textContent = ''; // No teacher info needed
                }
                 else {
                    const masterSchedule = schedule['1'] || [];
                    const currentHourIndex = daySchedule.findIndex(p => p.start === currentPeriod.start);
                    const originalPeriodIndex = masterSchedule.findIndex(p => p.class === currentPeriod.class && p.teacher === currentPeriod.teacher);
                    classInfoText.textContent = `Hour ${currentHourIndex + 1}`;
                    teacherInfoText.textContent = `Period ${originalPeriodIndex + 1}`;
                }
                periodTimesText.textContent = `${formatTime12Hour(currentPeriod.start)} - ${formatTime12Hour(currentPeriod.end)}`;
                statusText.textContent = `Time left in this period:`;
                targetTime = timeToDate(currentPeriod.end);

                 if (nextPeriod) {
                     if (isSignedIn && !isStingFest) {
                        nextClassText.textContent = `Next Up: ${nextPeriod.class} at ${formatTime12Hour(nextPeriod.start)}`;
                    } else if (isStingFest) {
                         nextClassText.textContent = `Next Up: ${nextPeriod.class} at ${formatTime12Hour(nextPeriod.start)}`;
                    }
                     else {
                        const masterSchedule = schedule['1'] || [];
                        const nextHourIndex = daySchedule.findIndex(p => p.start === nextPeriod.start);
                        const originalPeriodIndex = masterSchedule.findIndex(p => p.class === nextPeriod.class && p.teacher === nextPeriod.teacher);
                        nextClassText.textContent = `Next up: Hour ${nextHourIndex + 1} (Period ${originalPeriodIndex + 1}) at ${formatTime12Hour(nextPeriod.start)}`;
                    }
                 } else {
                    nextClassText.textContent = '';
                 }

            } else if (nextPeriod) {
                teacherInfoText.textContent = ''; periodTimesText.textContent = '';
                classInfoText.textContent = "Break Time!";
                statusText.textContent = 'Time until next class:';
                if (isSignedIn && !isStingFest) { 
                    nextClassText.textContent = `Next Up: ${nextPeriod.class} at ${formatTime12Hour(nextPeriod.start)}`; 
                } else if (isStingFest) {
                     nextClassText.textContent = `Next Up: ${nextPeriod.class} at ${formatTime12Hour(nextPeriod.start)}`;
                }
                 else { 
                    const masterSchedule = schedule['1'] || [];
                    const nextHourIndex = daySchedule.findIndex(p => p.start === nextPeriod.start);
                    const originalPeriodIndex = masterSchedule.findIndex(p => p.class === nextPeriod.class && p.teacher === nextPeriod.teacher);
                    nextClassText.textContent = `Next up: Hour ${nextHourIndex + 1} (Period ${originalPeriodIndex + 1}) at ${formatTime12Hour(nextPeriod.start)}`;
                }
                targetTime = timeToDate(nextPeriod.start);

            } else {
                periodTimesText.textContent = ''; nextClassText.textContent = '';
                liveTimerView.classList.add('hidden');
                finishedMessage.classList.remove('hidden');
                targetTime = null;
            }

            if (targetTime) {
                const distance = targetTime.getTime() - now.getTime();
                 if (distance > 0) {
                    const hours = Math.floor(distance / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    hoursEl.textContent = String(hours).padStart(2, '0');
                    minutesEl.textContent = String(minutes).padStart(2, '0');
                    secondsEl.textContent = String(seconds).padStart(2, '0');
                 } else { // Handle case where timer should be 00:00:00 briefly
                     hoursEl.textContent = '00';
                     minutesEl.textContent = '00';
                     secondsEl.textContent = '00';
                 }
            } else { // If school's out
                 hoursEl.textContent = '00';
                 minutesEl.textContent = '00';
                 secondsEl.textContent = '00';
            }
        }
        
        function updateHallwayDisplay() {
            // Use the day selected in the main dropdown for the hallway view
            const selectedDayValue = daySelector.value; 
            const { now, scheduleDay, currentPeriod, nextPeriod, daySchedule, isStingFest } = getScheduleState(selectedDayValue);
            
            timeElLarge.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second:'2-digit', hour12: true });
            dateElLarge.textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            hallwayDayNumberEl.textContent = scheduleDay; // Displays number or "Fest"
            
            let targetTime;
            const lunchA_startTime = timeToDate('11:05'), lunchA_endTime = timeToDate('11:39');
            const lunchB_startTime = timeToDate('12:09'), lunchB_endTime = timeToDate('12:39');

            const inALunch = now >= lunchA_startTime && now < lunchA_endTime;
            const inBLunch = now >= lunchB_startTime && now < lunchB_endTime;

            if (!isSignedIn && !isStingFest && currentPeriod && (inALunch || inBLunch)) {
                 hallwayClassNameEl.textContent = "A Lunch / B Lunch";
                hallwayTeacherNameEl.textContent = ``;
                hallwayPeriodTimesEl.textContent = `A: ${formatTime12Hour('11:05')} - ${formatTime12Hour('11:39')} | B: ${formatTime12Hour('12:09')} - ${formatTime12Hour('12:39')}`;
                
                if(inALunch){
                    hallwayStatusTextEl.textContent = `Time left for A Lunch`;
                    targetTime = lunchA_endTime;
                } else {
                    hallwayStatusTextEl.textContent = `Time left for B Lunch`;
                    targetTime = lunchB_endTime;
                }
                hallwayNextClassEl.textContent = '';
            }
            else if (currentPeriod && !isStingFest && inALunch && currentPeriod.lunch === 'A') {
                hallwayClassNameEl.textContent = "A Lunch";
                hallwayTeacherNameEl.textContent = "";
                hallwayPeriodTimesEl.textContent = `${formatTime12Hour('11:05')} - ${formatTime12Hour('11:39')}`;
                hallwayStatusTextEl.textContent = `Time left for A Lunch`;
                targetTime = lunchA_endTime;
                hallwayNextClassEl.textContent = '';
            } else if (currentPeriod && !isStingFest && inBLunch && currentPeriod.lunch === 'B') {
                hallwayClassNameEl.textContent = "B Lunch";
                hallwayTeacherNameEl.textContent = "";
                hallwayPeriodTimesEl.textContent = `${formatTime12Hour('12:09')} - ${formatTime12Hour('12:39')}`;
                hallwayStatusTextEl.textContent = `Time left for B Lunch`;
                targetTime = lunchB_endTime;
                hallwayNextClassEl.textContent = '';
            } else if(currentPeriod) { // Regular periods and Sting Fest periods
                const currentHourIndex = daySchedule.findIndex(p => p.start === currentPeriod.start);
                if (isSignedIn && !isStingFest) {
                    hallwayClassNameEl.textContent = currentPeriod.class;
                    hallwayTeacherNameEl.textContent = currentPeriod.teacher;
                } else if (isStingFest) {
                    hallwayClassNameEl.textContent = currentPeriod.class;
                    hallwayTeacherNameEl.textContent = '';
                }
                 else {
                    const masterSchedule = schedule['1'] || [];
                    const originalPeriodIndex = masterSchedule.findIndex(p => p.class === currentPeriod.class && p.teacher === currentPeriod.teacher);
                    hallwayClassNameEl.textContent = `Hour ${currentHourIndex + 1}`;
                    hallwayTeacherNameEl.textContent = `Period ${originalPeriodIndex + 1}`;
                }
                hallwayPeriodTimesEl.textContent = `${formatTime12Hour(currentPeriod.start)} - ${formatTime12Hour(currentPeriod.end)}`;
                hallwayStatusTextEl.textContent = `Time left in this period`;
                targetTime = timeToDate(currentPeriod.end);
                
                if (nextPeriod) {
                    const nextHourIndex = daySchedule.findIndex(p => p.start === nextPeriod.start);
                    if (isSignedIn && !isStingFest) {
                        hallwayNextClassEl.textContent = `Next Up: ${nextPeriod.class} at ${formatTime12Hour(nextPeriod.start)}`;
                    } else if (isStingFest){
                        hallwayNextClassEl.textContent = `Next Up: ${nextPeriod.class} at ${formatTime12Hour(nextPeriod.start)}`;
                    } else {
                        const masterSchedule = schedule['1'] || [];
                        const originalPeriodIndex = masterSchedule.findIndex(p => p.class === nextPeriod.class && p.teacher === nextPeriod.teacher);
                        hallwayNextClassEl.textContent = `Next Up: Hour ${nextHourIndex + 1} (Period ${originalPeriodIndex + 1}) at ${formatTime12Hour(nextPeriod.start)}`;
                    }
                } else {
                    hallwayNextClassEl.textContent = '';
                }

            } else if (nextPeriod) {
                hallwayClassNameEl.textContent = 'Break Time';
                hallwayTeacherNameEl.textContent = '';
                hallwayPeriodTimesEl.textContent = '';
                hallwayStatusTextEl.textContent = 'Time until next class';
                
                const nextHourIndex = daySchedule.findIndex(p => p.start === nextPeriod.start);
                if (isSignedIn && !isStingFest) {
                    hallwayNextClassEl.textContent = `Next Up: ${nextPeriod.class} at ${formatTime12Hour(nextPeriod.start)}`;
                } else if (isStingFest){
                    hallwayNextClassEl.textContent = `Next Up: ${nextPeriod.class} at ${formatTime12Hour(nextPeriod.start)}`;
                } else {
                    const masterSchedule = schedule['1'] || [];
                    const originalPeriodIndex = masterSchedule.findIndex(p => p.class === nextPeriod.class && p.teacher === nextPeriod.teacher);
                    hallwayNextClassEl.textContent = `Next Up: Hour ${nextHourIndex + 1} (Period ${originalPeriodIndex + 1}) at ${formatTime12Hour(nextPeriod.start)}`;
                }
                targetTime = timeToDate(nextPeriod.start);
            } else {
                hallwayClassNameEl.textContent = "School's Out";
                hallwayTeacherNameEl.textContent = 'Have a great day!';
                hallwayPeriodTimesEl.textContent = '';
                hallwayStatusTextEl.textContent = '';
                hallwayNextClassEl.textContent = '';
                targetTime = null;
            }
            
            if (targetTime) {
                const distance = targetTime.getTime() - now.getTime();
                 if (distance > 0) {
                    const hours = Math.floor(distance / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    hallwayHoursEl.textContent = String(hours).padStart(2, '0');
                    hallwayMinutesEl.textContent = String(minutes).padStart(2, '0');
                    hallwaySecondsEl.textContent = String(seconds).padStart(2, '0');
                } else {
                    hallwayHoursEl.textContent = '00';
                    hallwayMinutesEl.textContent = '00';
                    hallwaySecondsEl.textContent = '00';
                }
            } else {
                 hallwayHoursEl.textContent = '00';
                 hallwayMinutesEl.textContent = '00';
                 hallwaySecondsEl.textContent = '00';
            }
        }
        
        function startMainDisplay() {
            clearInterval(mainInterval);
            updateMainDisplay();
            mainInterval = setInterval(updateMainDisplay, 1000);
        }

        function startHallwayDisplay() {
            clearInterval(hallwayInterval);
            loadDataFromStorage();
            updateHallwayDisplay();
            hallwayInterval = setInterval(updateHallwayDisplay, 1000);
        }

        function stopHallwayDisplay() {
            clearInterval(hallwayInterval);
        }

        // --- SCHEDULE EDITOR LOGIC ---
        function createPeriodElement(period = { class: '', teacher: '', start: '', end: '', lunch: 'none' }) {
            const div = document.createElement('div');
            div.className = 'period-entry grid grid-cols-1 sm:grid-cols-2 gap-2 bg-zinc-800 p-3 rounded-lg';
            div.innerHTML = `<div class="space-y-2"><input type="text" placeholder="Class Name" class="class-name bg-zinc-700 text-white p-2 rounded-md w-full" value="${period.class}"><input type="text" placeholder="Teacher's Name" class="teacher-name bg-zinc-700 text-white p-2 rounded-md w-full" value="${period.teacher}"></div><div class="space-y-2"><div class="flex items-center gap-2"><input type="time" class="start-time bg-zinc-700 text-white p-2 rounded-md w-full" value="${period.start}"><span class="text-zinc-400">-</span><input type="time" class="end-time bg-zinc-700 text-white p-2 rounded-md w-full" value="${period.end}"></div><div class="flex items-center gap-2"><select class="lunch-type bg-zinc-700 text-white p-2 rounded-md w-full"><option value="none">No Lunch</option><option value="A">A Lunch</option><option value="B">B Lunch</option></select><button class="delete-period-btn bg-red-500 hover:bg-red-600 text-white font-bold p-2 rounded-md">X</button></div></div>`;
            div.querySelector('.delete-period-btn').addEventListener('click', () => div.remove());
            div.querySelector('.lunch-type').value = period.lunch || 'none';
            return div;
        }
        function renderScheduleEditor() {
            periodsContainer.innerHTML = '';
            const masterSchedule = schedule['1'] || [];
            masterSchedule.forEach(period => { periodsContainer.appendChild(createPeriodElement(period)); });
        }
        function savePeriodsFromUI() {
            const periodEntries = periodsContainer.querySelectorAll('.period-entry');
            const newMasterSchedule = [];
            periodEntries.forEach(entry => {
                const classVal = entry.querySelector('.class-name').value.trim();
                const teacherVal = entry.querySelector('.teacher-name').value.trim();
                const startVal = entry.querySelector('.start-time').value;
                const endVal = entry.querySelector('.end-time').value;
                const lunchVal = entry.querySelector('.lunch-type').value;
                if(classVal && startVal && endVal) { newMasterSchedule.push({ class: classVal, teacher: teacherVal, start: startVal, end: endVal, lunch: lunchVal }); }
            });
            newMasterSchedule.sort((a, b) => a.start.localeCompare(b.start));
            schedule['1'] = newMasterSchedule;
        }

        // --- EVENT LISTENERS ---
        signInBtn.addEventListener('click', () => showView('pin'));
        pinBackBtn.addEventListener('click', () => showView('main'));
        pinSubmitBtn.addEventListener('click', () => {
            if (pinInput.value === '9900') {
                isSignedIn = true; updateAuthUI(); startMainDisplay(); showView('main');
            } else { pinError.textContent = 'Incorrect PIN.'; pinInput.value = ''; }
        });
        signOutBtn.addEventListener('click', () => { isSignedIn = false; updateAuthUI(); startMainDisplay(); });
        
        // View switching
        editScheduleBtn.addEventListener('click', () => { renderScheduleEditor(); showView('scheduleEditor'); });
        backToMainBtn.addEventListener('click', () => { loadDataFromStorage(); showView('main'); });
        calendarBtn.addEventListener('click', () => {
            const today = new Date();
            if (!selectedDate) {
                 const firstEventDateKey = Object.keys(events).sort()[0];
                if (firstEventDateKey) {
                    const [year, month, day] = firstEventDateKey.split('-').map(Number);
                    calendarDate = new Date(year, month - 1, 1);
                    selectedDate = firstEventDateKey;
                } else {
                    calendarDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    selectedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                }
            } else {
                // If a date is already selected, make sure the calendarDate matches its month/year
                 const [sYear, sMonth] = selectedDate.split('-').map(Number);
                 calendarDate = new Date(sYear, sMonth - 1, 1);
            }
           
            renderCalendar(); 
            showEventsForDate(selectedDate); 
            showView('calendar');
        });
        calendarBackBtn.addEventListener('click', () => showView('main'));
        hallwayViewBtn.addEventListener('click', () => showView('hallway'));
        hallwayBackBtn.addEventListener('click', () => showView('main'));

        // Main app logic
        saveScheduleBtn.addEventListener('click', () => { savePeriodsFromUI(); saveScheduleToStorage(); startMainDisplay(); showView('main'); });
        addPeriodBtn.addEventListener('click', () => { periodsContainer.appendChild(createPeriodElement()); });
        daySelector.addEventListener('change', (e) => startMainDisplay());

        // --- CALENDAR LOGIC ---
        function renderCalendar() {
            calendarDays.innerHTML = '';
            const month = calendarDate.getMonth();
            const year = calendarDate.getFullYear();
            monthYearText.textContent = `${calendarDate.toLocaleString('default', { month: 'long' })} ${year}`;
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarDays.innerHTML += `<div></div>`;
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const day = document.createElement('div');
                day.textContent = i;
                day.className = 'calendar-day p-2 rounded-full cursor-pointer hover:bg-zinc-700';
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                const dayData = events[dateKey] || { events: [], scheduleDay: 0 };

                if (dayData.events.length > 0) {
                    day.classList.add('has-event');
                }
                
                if (dayData.scheduleDay > 0) {
                    const indicator = document.createElement('span');
                    indicator.className = 'schedule-day-indicator';
                    indicator.textContent = `D${dayData.scheduleDay}`;
                    day.appendChild(indicator);
                }

                if (selectedDate && dateKey === selectedDate) {
                    day.classList.add('selected');
                }

                day.addEventListener('click', () => {
                    selectedDate = dateKey;
                    renderCalendar();
                    showEventsForDate(dateKey);
                });
                calendarDays.appendChild(day);
            }
        }
        
        function showEventsForDate(dateKey) {
            const [year, month, day] = dateKey.split('-');
            const date = new Date(year, month - 1, day);
            selectedDateText.textContent = `Details for ${date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}`;
            eventList.innerHTML = '';
            
            const dayData = events[dateKey] || { events: [], scheduleDay: 0 };
            dayTypeSelector.value = dayData.scheduleDay;

            if (dayData.events.length === 0) {
                eventList.innerHTML = `<p class="text-zinc-500">No events for this day.</p>`;
            } else {
                dayData.events.forEach((eventText, index) => {
                    const li = document.createElement('div');
                    li.className = 'bg-zinc-800 p-2 rounded-md flex justify-between items-center';
                    li.textContent = eventText;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'X';
                    deleteBtn.className = 'text-red-400 hover:text-red-300 font-bold text-xs ml-2';
                    deleteBtn.onclick = () => {
                        events[dateKey].events.splice(index, 1);
                        saveEventsToStorage();
                        renderCalendar();
                        showEventsForDate(dateKey);
                    };
                    li.appendChild(deleteBtn);
                    eventList.appendChild(li);
                });
            }
        }
        todayBtn.addEventListener('click', () => {
            const today = new Date(); calendarDate = new Date(today.getFullYear(), today.getMonth(), 1);
            selectedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            renderCalendar(); showEventsForDate(selectedDate);
        });
        goToDateBtn.addEventListener('click', () => {
            const dateValue = datePickerInput.value;
            if (dateValue) {
                const [year, month, day] = dateValue.split('-').map(Number);
                calendarDate = new Date(year, month - 1, 1); selectedDate = dateValue;
                datePickerInput.value = ''; renderCalendar(); showEventsForDate(selectedDate);
            }
        });
        dayTypeSelector.addEventListener('change', (e) => {
            if (selectedDate) {
                if (!events[selectedDate]) { events[selectedDate] = { events: [], scheduleDay: 0 }; }
                events[selectedDate].scheduleDay = parseInt(e.target.value, 10);
                saveEventsToStorage(); // Corrected saving function here
                renderCalendar();
            }
        });
        prevMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
        nextMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });
        addEventBtn.addEventListener('click', () => {
            const eventText = eventInput.value.trim();
            if (eventText && selectedDate) {
                if (!events[selectedDate]) { events[selectedDate] = { events: [], scheduleDay: 0 }; }
                events[selectedDate].events.push(eventText);
                saveEventsToStorage(); eventInput.value = ''; renderCalendar(); showEventsForDate(selectedDate);
            }
        });


        // --- INITIALIZATION ---
        function init() {
            loadDataFromStorage();
            const today = new Date();
            
            const savedEvents = localStorage.getItem('schoolEvents');
            if (!savedEvents) {
                const firstEventDateKey = Object.keys(events).sort()[0];
                if (firstEventDateKey) {
                    const [year, month] = firstEventDateKey.split('-').map(Number);
                    calendarDate = new Date(year, month - 1, 1);
                } else {
                    calendarDate = new Date(today.getFullYear(), today.getMonth(), 1);
                }
            } else { 
                calendarDate = new Date(today.getFullYear(), today.getMonth(), 1); 
            }
            
            const todayKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const todayEventData = events[todayKey] || { scheduleDay: 0 };

            if (todayEventData.scheduleDay > 0) { daySelector.value = todayEventData.scheduleDay; } 
            else { const dayOfWeek = today.getDay(); daySelector.value = (dayOfWeek === 0 || dayOfWeek === 6) ? '1' : String(dayOfWeek); }

            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            startMainDisplay();
            updateAuthUI();
            showView('main');
        }

        init();
    });
    </script>
</body>
</html>



